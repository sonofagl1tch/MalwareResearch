#!/bin/bash
#Noriben Sandbox Automation Script
#Responsible for:
#* Copying malware into a known VM
#* Running malware sample
#* Copying off results
#
#Ensure you set the environment variables below to match your system
##############################################################
if [ ! -f $1 ]; then
	echo "Please provide executable filename as an argument."
	echo "For example:"
	echo "$0 ~/malware/ef8188aa1dfa2ab07af527bab6c8baf7"
	exit
fi
##############################################################
# host based configuration variables
# current username
USERNAME=$(whoami)
# reads in commandline arguement for sample
MALWAREFILE=$1
# used for noriben output files
FILENAME=$(basename $MALWAREFILE)
# full path to vmrun binary. this is required to be referenced in the full path everytime
VMRUN="/Applications/VMware Fusion.app/Contents/Library/vmrun"
# full path to noriben victim vm vmx file
VMX="/Users/$USERNAME/Documents/Virtual Machines.localized/noriben.vmwarevm/noriben.vmx"
# this is the name of the snapshot to revert the vm to
VM_SNAPSHOT="Baseline"
# guest VM username and password
VM_USER=master
VM_PASS=master
# local host file path for procmon
PROCMON="/Users/$USERNAME/Downloads/Procmon.exe"
# local host file path for procmon configuration file
PROCMONCONFIG="/Users/$USERNAME/Downloads/ProcmonConfiguration.pmc"
##############################################################
# guest based configuration variables
# variable for execution delay
DELAY=10
# noriben path on guest
NORIBEN_PATH="C:\\Users\\master\\Downloads\\Noriben.py"
# zipped noriben results path on guest
ZIP_PATH="C:\\Tools\\zip.exe"
# noriben results path on guest
LOG_PATH="C:\\Noriben_Logs"
# python path on guest
PYTHON_PATH="C:\\Users\\master\\AppData\\Local\\Programs\\Python\\Python36\\python.exe"
# procmon path on guest
PROCMONPATH="C:\\Users\\master\\Downloads\\chrome.exe"
# procmon configuration file path on guest
PROCMONCONFIGPATH="C:\\Users\\master\\Downloads\\ProcmonConfiguration.pmc"
# sample path on guest
MALWARE_PATH="C:\\Users\\master\\Downloads\\Malware.exe"
##############################################################
# revert vm to baseline snapshot
"$VMRUN" -T ws revertToSnapshot "$VMX" "$VM_SNAPSHOT"
# start revert vm (aka poweron)
"$VMRUN" -T ws start "$VMX"
# copy over procmon to guest VM
"$VMRUN" -gu $VM_USER -gp $VM_PASS copyFileFromHostToGuest "$VMX" "$PROCMON" "$PROCMONPATH"
# copy over procmon config file to guest VM
"$VMRUN" -gu $VM_USER -gp $VM_PASS copyFileFromHostToGuest "$VMX" "$PROCMONCONFIG" "$PROCMONCONFIGPATH"
# copy over Malware Sample to guest VM
"$VMRUN" -gu $VM_USER -gp $VM_PASS copyFileFromHostToGuest "$VMX" "$MALWAREFILE" "$MALWARE_PATH"
##############################################################
# run malware sample on guest VM
"$VMRUN" -T ws -gu $VM_USER -gp $VM_PASS runProgramInGuest "$VMX" "$PYTHON_PATH" "$NORIBEN_PATH" -d -t $DELAY --cmd "$MALWARE_PATH" --output "$LOG_PATH"
if [ $? -gt 0 ]; then
    echo "[!] File did not execute in VM correctly."
    exit
fi
##############################################################
# zip up norien report
"$VMRUN" -T ws -gu $VM_USER -gp $VM_PASS runProgramInGuest "$VMX" "$ZIP_PATH" -j C:\\NoribenReports.zip "$LOG_PATH\\*.*"
if [ $? -eq 12 ]; then
    echo "[!] ERROR: No files found in Noriben output folder to ZIP."
    exit
fi
##############################################################
# copy zipped noriben report files to host
"$VMRUN" -gu $VM_USER -gp $VM_PASS copyFileFromGuestToHost "$VMX" C:\\NoribenReports.zip $PWD/NoribenReports_$FILENAME.zip
