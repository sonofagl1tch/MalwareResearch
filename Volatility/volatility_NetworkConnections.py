# Author Ryan Nolette
# Date Modified 12/30/2016
# Description: This script will accept a raw memeory dump and run it through various volatility commands to output a list of network connections
# Usage: python volatility_NetworkConnections.py /Users/master/Documents/DESKTOP-GKQPKB6-20161228-183619.raw
# requires: openpyxl ad styleframe to work
# pip install openpyxl
# pip install StyleFrame
#

##############################################################
import os
import sys
import subprocess
from os.path import expanduser
##############################################################

##############################################################
def GetProfile(VOLATILITY_PATH, MEM_CAPTURE):
    # This runs the volatility command below to get the suggest profiles
    # output example: Suggested Profile(s) : Win10x64_10586, Win10x64_14393, Win10x64, Win2016x64_14393
    #this command will get the suggest OS profiles from volatility
    GET_PROFILe="python " + VOLATILITY_PATH + " -f " + MEM_CAPTURE + " imageinfo"
    # create variable to be passed to next function
    for line in subprocess.check_output(GET_PROFILe, shell=True).split('\n'):
        if "Suggested Profile(s)"  in line:
            input = line
            FirstProfile(VOLATILITY_PATH, MEM_CAPTURE, input)
##############################################################

##############################################################
def FirstProfile(VOLATILITY_PATH, MEM_CAPTURE, input):
    # dump the hives. We are interested in 2 offsets: SYSTEM (-y) and SAM (-s)
    # \systemRoot\System32\Config\SAM
    # \REGISTRY\MACHINE\SYSTEM
    # $ ./vol.py -f memory.dmp --profile=Win7SP1x86 hivelist
    # create variable to be passed to next function
    for line in input.split(':'):
        if "Suggested" not in line:
            profiles = line.split(',')
            FIRST_PROFILE = profiles[0].strip()
            GETNETWORKCONNECTIONS(VOLATILITY_PATH, MEM_CAPTURE, FIRST_PROFILE)
##############################################################

##############################################################
def GETNETWORKCONNECTIONS(VOLATILITY_PATH, MEM_CAPTURE, FIRST_PROFILE):
    #vol.py -f WIN7-20161231-015126.raw --profile=Win7SP1x64 netscan --plugin=plugins/ --output=xlsx --output-file=netscan.xlsx
    HOME=expanduser("~")
    XLSX_FILE=HOME + "/Downloads/netscan.xlsx"
    GET_NETWORK_CONNECTIONS="python " + VOLATILITY_PATH + " -f " + MEM_CAPTURE + " --profile=" + FIRST_PROFILE + " --plugin=plugins/ --output=xlsx --output-file=" + XLSX_FILE + " netscan"
    #
    subprocess.check_output(GET_NETWORK_CONNECTIONS, shell=True)
##############################################################

##############################################################
#Where you installed volatility to. use "which vol.py" to find it if you cant remember.
VOLATILITY_PATH="/usr/local/bin/vol.py"
#get command line arguement for the path to the memory image you will be analyzing
CAPTURE=sys.argv[1]
#add qoutes around file path so spaces are ignored
MEM_CAPTURE="\"" + CAPTURE + "\""
#start process
GetProfile(VOLATILITY_PATH, MEM_CAPTURE)
##############################################################
