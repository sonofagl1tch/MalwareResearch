# Author Ryan Nolette
# Date Modified 12/30/2016
# Description: This script will accept a raw memeory dump and run it through various volatility commands to output a list of running processes that is used to generate a graphical process tree
# Usage: python volatility_pslistToDot.py /Users/master/Documents/DESKTOP-GKQPKB6-20161228-183619.raw
# requires the installation of graphviz from http://www.graphviz.org/
# dot format - "hierarchical" or layered drawings of directed graphs. This is the default tool to use if edges have directionality.
# 

##############################################################
import os
import sys
import subprocess
from os.path import expanduser
##############################################################

##############################################################
def GetProfile(VOLATILITY_PATH, MEM_CAPTURE):
    # This runs the volatility command below to get the suggest profiles
    # output example: Suggested Profile(s) : Win10x64_10586, Win10x64_14393, Win10x64, Win2016x64_14393
    #this command will get the suggest OS profiles from volatility
    GET_PROFILe="python " + VOLATILITY_PATH + " -f " + MEM_CAPTURE + " imageinfo"
    # create variable to be passed to next function
    for line in subprocess.check_output(GET_PROFILe, shell=True).split('\n'):
        if "Suggested Profile(s)"  in line:
            input = line
            FirstProfile(VOLATILITY_PATH, MEM_CAPTURE, input)
##############################################################

##############################################################
def FirstProfile(VOLATILITY_PATH, MEM_CAPTURE, input):
    # dump the hives. We are interested in 2 offsets: SYSTEM (-y) and SAM (-s)
    # \systemRoot\System32\Config\SAM
    # \REGISTRY\MACHINE\SYSTEM
    # $ ./vol.py -f memory.dmp --profile=Win7SP1x86 hivelist
    # create variable to be passed to next function
    for line in input.split(':'):
        if "Suggested" not in line:
            profiles = line.split(',')
            FIRST_PROFILE = profiles[0].strip()
            GETPSLIST(VOLATILITY_PATH, MEM_CAPTURE, FIRST_PROFILE)
##############################################################

##############################################################
def GETPSLIST(VOLATILITY_PATH, MEM_CAPTURE, FIRST_PROFILE):
    #vol.py -f WIN7-20161231-015126.raw --profile=Win7SP1x64 --plugin=plugins/ --output=dot --output-file=pslist.dot pslist
    HOME=expanduser("~")
    DOT_FILE=HOME + "/Downloads/pslist.dot"
    GET_PSLIST="python " + VOLATILITY_PATH + " -f " + MEM_CAPTURE + " --profile=" + FIRST_PROFILE + " --plugin=plugins/ --output=dot --output-file=" + DOT_FILE + " pslist"
    #
    subprocess.check_output(GET_PSLIST, shell=True)
    OPENDOTFILE(DOT_FILE)

##############################################################

##############################################################
def OPENDOTFILE(DOT_FILE):
    #
    GRAPHVIZ="/Applications/Graphviz.app/Contents/MacOS/Graphviz"
    subprocess.Popen([GRAPHVIZ, DOT_FILE])

##############################################################

##############################################################
#Where you installed volatility to. use "which vol.py" to find it if you cant remember.
VOLATILITY_PATH="/usr/local/bin/vol.py"
#get command line arguement for the path to the memory image you will be analyzing
CAPTURE=sys.argv[1]
#add qoutes around file path so spaces are ignored
MEM_CAPTURE="\"" + CAPTURE + "\""
#start process
GetProfile(VOLATILITY_PATH, MEM_CAPTURE)
##############################################################
